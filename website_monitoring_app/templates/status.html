<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<div class="container my-4">
  <a href="/" class="btn btn-outline-secondary mb-3">
    &larr; Back
  </a>

<h2> <strong>Status for: </strong> <span class="mb-2 text-primary fw-bold"> {{ website_name }} </span></h2>
<h3 class="text-secondary">{{ url }}</h3>
<h4 class="mb-3">
  <span class="me-3">
    <strong>Availability:</strong>
    <span class="text-muted">{{ website_availability }}</span>
  </span>
  <span class="me-3">
    <strong>Average Response (seconds):</strong>
    <span class="text-muted">{{ average_response_time }}</span>
  </span>
  <span class="me-3">
    <strong>Current Status:</strong>
    <span class="text-muted">{{ current_status }}</span>
  </span>
  <span>
    <strong>Total Checks:</strong>
    <span class="text-muted">{{ total_count }}</span>
  </span>
</h4>

  <!-- Filters -->
  <div class="row mb-3">
    <div class="col-md-3">
      <label for="statusFilter" class="form-label">Filter Status</label>
      <select id="statusFilter" class="form-select">
        <option value="">All</option>
        <option value="online">Online (available)</option>
        <option value="warning">Warning (not available)</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="daysFilter" class="form-label">Filter by Days</label>
      <select id="daysFilter" class="form-select">
        <option value="">All</option>
        <option value="1">Last 1 day</option>
        <option value="3">Last 3 days</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
      </select>
    </div>
  </div>

  <table class="table table-striped table-bordered" id="logsTable">
    <thead class="table-light">
      <tr>
        <th>Status</th>
        <th>Response Time (s)</th>
        <th id="requestedAtHeader" style="cursor: pointer;">
          Requested At <span id="sortIndicator">▲</span>
        </th>
      </tr>
    </thead>
    <tbody>
      {% for log in log_of_website %}
      <tr>
        <td>{{ log[0] }}</td>
        <td>{{ "%.3f" | format(log[1]) }}</td>
        <td>{{ log[2] }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
// Parse ISO date string to Date object
function parseDate(dateStr) {
  return new Date(dateStr);
}

document.addEventListener('DOMContentLoaded', function () {
  const statusFilter = document.getElementById('statusFilter');
  const daysFilter = document.getElementById('daysFilter');
  const requestedAtHeader = document.getElementById('requestedAtHeader');
  const sortIndicator = document.getElementById('sortIndicator');
  const table = document.getElementById('logsTable');
  const tbody = table.querySelector('tbody');
  let rows = Array.from(tbody.querySelectorAll('tr'));

  let sortAsc = true; // Initial sort ascending

  function sortRows() {
    rows.sort((a, b) => {
      const dateA = parseDate(a.cells[2].textContent.trim());
      const dateB = parseDate(b.cells[2].textContent.trim());
      return sortAsc ? dateA - dateB : dateB - dateA;
    });

    rows.forEach(row => tbody.appendChild(row));
  }

  function filterTable() {
    const statusValue = statusFilter.value;
    const daysValue = daysFilter.value ? parseInt(daysFilter.value) : null;
    const now = new Date();

    rows.forEach(row => {
      const status = row.cells[0].textContent.trim();
      const requestedAtStr = row.cells[2].textContent.trim();
      const requestedAt = parseDate(requestedAtStr);

      let show = true;

      // Filter by status
     const statusCode = Number(row.cells[0].textContent.trim());

     if (statusValue === 'online') {
        if (!(statusCode >= 100 && statusCode < 400)) show = false;
     } else if (statusValue === 'warning') {
        if (statusCode >= 100 && statusCode < 400) show = false;
     } else {
        show = true;
     }


      // Filter by date range
      if (daysValue) {
        const diffMs = now - requestedAt;
        const diffDays = diffMs / (1000 * 60 * 60 * 24);
        if (diffDays > daysValue) show = false;
      }

      row.style.display = show ? '' : 'none';
    });
  }

  // Toggle sorting on header click
  requestedAtHeader.addEventListener('click', () => {
    sortAsc = !sortAsc;
    sortIndicator.textContent = sortAsc ? '▲' : '▼';
    sortRows();
  });

  statusFilter.addEventListener('change', () => {
    filterTable();
  });

  daysFilter.addEventListener('change', () => {
    filterTable();
  });

  // Initial sorting and filtering
  sortRows();
  filterTable();
});
</script>
